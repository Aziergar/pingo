<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src = "https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.js"></script>
    <script src = "../js/functions.js"></script>
    <script src = "../js/instruments.js"></script>
    <script src = "../js/editor.js"></script>
    <script src = "../js/room.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/editor.css">
</head>
<body style="display:'grid'" >
<div class="first-column" style="grid-row: '1'">
    <div class="panel" >
        <h1>pingo</h1>
        <div class="box-buttons-panel-left">
             <input type = "button" class = "Mode" id = "SelectImage"  style="background-image: url(../img/arrow.png); background-size: cover"/>
             <input type = "button" class = "Mode" id = "Brushes" style="background-image: url(../img/brush.png); background-size: cover" />
             <input type = "button" class = "Mode" id = "Figures" style="background-image: url(../img/figures.png); background-size: cover" />
             <input type = "button" class = "Mode" id = "Text" style="background-image: url(../img/text.png); background-size: cover" />
             <input type = "button" class = "Mode" id = "Download" style ="background-image: url(../img/download.png); background-size: cover" />
             <!--<input type = "button" class = "Mode" id = "Action1" style="background-image: url({% static 'img/action1.png' %}); background-size: cover"/>
             <input type = "button" class = "Mode" id = "Action2" style="background-image: url({% static 'img/action2.png' %}); background-size: cover"/>-->
        </div>
             <input type = "button" class = "Mode Right" id = "SettingRoom"  style="background-image: url(../img/setting.png); background-size: cover"/>
             <input type = "button" class = "Mode Right" id = "Exit" style="background-image: url(../img/exit.png); background-size: cover"/>
    </div>
     <div id = "Content" style = "width: 800px; height: 520px; position: relative; margin: auto; overflow: hidden;"></div>
</div>

<div class="second-column" style="grid-row: '1'">

<div class="settingInstruments" id="brushes_display" style="display:none;">
    <div class="text-text-Setting"> - Brushes - </div>
    <div class="text-Setting">
    <div class="instrumentCase">
        <input type = "button" class = "Mode instrumentsBrushes" id = "Marker"  style="background-image: url(../img/marker.png); background-size: cover"/>
        <input type = "button" class = "Mode instrumentsBrushes" id = "Pencil"  style="background-image: url(../img/pencil.png); background-size: cover"/>
        <input type = "button" class = "Mode instrumentsBrushes" id = "Eraser"  style="background-image: url(../img/eraser.png); background-size: cover"/>
        <input type = "button" class = "Mode instrumentsBrushes" id = "Spray"  style="background-image: url(../img/spray.png); background-size: cover"/>
        <input type = "button" class = "Mode instrumentsBrushes" id = "Fill"  style="background-image: url(../img/placeholder.png); background-size: cover"/>
    </div>
     <div class="thicknessContainer">
     <div class="thickness">
     <div class="text-edit"> толщина </div>
     <input type="number" id = "ThicknessText" class="brushes-edit" />
      </div>
         <div>
             <input type="range" class="range-input" id = "ThicknessSlider" min="1" max="100" value="50">
         </div>
    </div>
        <div class="opacityContainer">
            <div class="opacity">
                <div class="text-edit"> непрозрачность </div>
                <input type="number" class="brushes-edit" id = "TransparencyText" />
            </div>
            <div>
                <input type="range" class="range-input" id = "TransparencySlider" min="1" max="255" value="127">
            </div>
        </div>
        <input type="color" class="main" />
        <div class="colors">
            <div class="twelve-box">
                <div class="box1">
                    <div style="background:#FFFFFF" class="twelve " ></div>
                    <div style="background:#C8C8C2" class="twelve " ></div>
                    <div style="background:#605F54" class="twelve " ></div>
                    <div style="background:#030303" class="twelve " ></div>
                    <div style="background:#B12B2B" class="twelve " ></div>
                    <div style="background:#FF0000" class="twelve " ></div>
                </div>
                <div class="box2">
                    <div style="background:#FFC700 " class="twelve " ></div>
                    <div style="background:#FFF500" class="twelve " ></div>
                    <div style="background:#24FF00" class="twelve " ></div>
                    <div style="background:#00FFF0" class="twelve " ></div>
                    <div style="background:#0047FF" class="twelve " ></div>
                    <div style="background:#EB00FF" class="twelve " ></div>
                </div>
            </div>
              <input type = "button" class = "addClass" id = "Add"  style="background-image: url(../img/add.png); background-size: cover"/>
        </div>
</div>
</div>
    <div class="settingInstruments" id="figures_display" style="display:block;">
        <div class="text-text-Setting"> - Figures - </div>
        <div class="text-Setting">
        <div class="box-figures-Setting">
            <input type = "button" class = "Mode figuresIntSetting" id = "Line"  style="background-image: url(../img/line.png); background-size: cover"/>
            <input type = "button" class = "Mode figuresIntSetting" id = "Rect"  style="background-image: url(../img/square.png); background-size: cover"/>
            <input type = "button" class = "Mode figuresIntSetting" id = "Ellipse"  style="background-image: url(../img/circle.png); background-size: cover"/>
            <input type = "button" class = "Mode figuresIntSetting" id = "Triangle"  style="background-image: url(../img/triangle.png); background-size: cover"/>
        </div>
        </div>
    </div>
    <div class="settingInstruments" id="text_display" style="display:none;">
        <div class="text-text-Setting"> - Text - </div>
                <div class="text-Setting">
                    <div class="box-text">
                        <select name="select-text-Setting" >
                            <option selected value="s1"> Шрифт1 </option>
                            <option selected value="s2"> Шрифт2 </option>
                            <option selected value="s3"> Шрифт3 </option>
                            <option selected value="s4"> Arial </option>
                        </select>
                        <div class="size-text">
                            <select name="size-select-text" >
                                <option selected value="s1"> 5 </option>
                                <option selected value="s2"> 10 </option>
                                <option selected value="s3"> 15 </option>
                                <option selected value="s4"> 20</option>
                            </select>
                                <input type="color" class="icon-color" />
                        </div>
                        <div class="change-text">
                            <input type = "button" class = "buttons-text" id = "bold"  style="background-image: url(../img/bold.png); background-size: cover"/>
                            <input type = "button" class = "buttons-text" id = "italic"  style="background-image: url(../img/italic.png); background-size: cover"/>
                            <input type = "button" class = "buttons-text" id = "underline"  style="background-image: url(../img/underline.png); background-size: cover"/>
                        </div>
                        <div class="change-position">
                            <input type = "button" class = "buttons-text2" id = "leftText"  style="background-image: url(../img/left.png); background-size: cover"/>
                            <input type = "button" class = "buttons-text2" id = "centerText"  style="background-image: url(../img/center.png); background-size: cover"/>
                            <input type = "button" class = "buttons-text2" id = "rightText"  style="background-image: url(../img/right.png); background-size: cover"/>
                        </div>
                    </div>
                </div>
    </div>


    <div class="settingRoomInfo" id="settingRoomInfo">

        Your name:{{username}} {{username|json_script:"user-name"}}<br>
        Your status:<span id="my_status"> {{status}} {{status|json_script:"status"}}</span><br>
        Room name:{{room_name}} {{room_name|json_script:"room-name" }}<br>
        <div id="roommates">
            <ul id="list_roommates">
                Roommates: <br>{% for i in roommates %}
                    {% if i.name == username %}
                    {% else %}
                     <li id="li_{{i.name}}">
                        {{i.name}}:
                        {% if status == 'Creator' %}
                            <select name="select-name" onchange="ChangeStatus(this)" id = "{{i.name}}">
                                &#9
                                {% if i.status == 'Witness' %}
                                    <option id = "_witness">Witness</option>
                                    <option id = "_editor">Editor</option>
                                {% else %}
                                &#9
                                    <option id = "_editor">Editor</option>
                                    <option id = "_witness">Witness</option>
                                {%endif%}
                                <input type="button" id="delete_{{i.name}}" onclick="deleteUser(this)" value="X"></input>
                            </select>
                        {% else %}
                            <span id="{{i.name}}_status">{{i.status}}</span>
                        {% endif %}
                     {%endif%}
                     </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="chat">
        <textarea id="chat-log" cols="100" rows="20"></textarea>
        <div class="textChat" >
            <input id="chat-message-input" type="text" size="100">
            <input id="chat-message-submit" type="button" value="Send">
        </div>
    </div>
    <main>

    </main>
</div>

</div>
    <script>
    brushes_display = document.getElementById('brushes_display');
    text_display= document.getElementById('text_display');
    figures_display = document.getElementById('figures_display');

    brushes = document.getElementById('Brushes');
    text = document.getElementById('Text');
    figures =document.getElementById('Figures');

    figures.addEventListener('click', (event) => {
        brushes_display.style.display = "none";
        text_display.style.display = "none";
        figures_display.style.display = "block";
    });

    text.addEventListener('click', (event) => {
        brushes_display.style.display = "none";
        text_display.style.display = "block";
        figures_display.style.display = "none";
    });

    brushes.addEventListener('click', (event) => {
        brushes_display.style.display = "block";
        text_display.style.display = "none";
        figures_display.style.display = "none";
    });

    exit = document.getElementById('Exit');
    exit.addEventListener('click', (event) => {
        if (status == 'Creator'){
             chatSocket.send(
                JSON.stringify({
                    type: "creator_close",
                    username: username,
                })
            );
        }
        else {
            chatSocket.send(
                JSON.stringify({
                    type: "exit",
                    username: username,
                })
            );
        }
    });

    SettingRoom = document.getElementById('SettingRoom');
    el = document.getElementById('settingRoomInfo');
    SettingRoom.addEventListener('click', () => {
        el.style.display = "block";
    });

    document.addEventListener('click', (event) => {
          const isClickInsideMenu = SettingRoom.contains(event.target);
          const isClickInsideButton = el.contains(event.target);
          if (!isClickInsideMenu && !isClickInsideButton) {
            el.style.display = "none";
          }
    });

        window.onbeforeunload = function() {
          return false;
        };

        window.onunload = function() {
            chatSocket.send(
                JSON.stringify({
                    type: "unload",
                    username: username,
                })
            );
        };

        function deleteUser(e){
            e.parentElement.remove();
            id = e.getAttribute('id');
            chatSocket.send(
                JSON.stringify({
                    type: "deleteUser",
                    username: id,
                })
            );
        }
        let drawData = [];
        let gotData = false;

        var status = JSON.parse(document.getElementById('status').textContent);
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const username = JSON.parse(document.getElementById('user-name').textContent);

        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/' + roomName + '/'
        );

        chatSocket.onopen = function(e){
            chatSocket.send(
                JSON.stringify({
                    type: "joined",
                    username: username,
                    status: status,
                })
            );
        };

        function ChangeStatus(selectObject) {
            var value = selectObject.value;
            chatSocket.send(JSON.stringify({
                type: "change_status",
                username: selectObject.getAttribute("id"),
                status: value,
            }));
        }

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const type = data.type;
            if (type == "chat_message"){
                document.querySelector('#chat-log').value += (data.username + ': ' + data.message + '\n');
            }
            if (type == "joined"){
                    var username2 = data.username;
                    document.querySelector('#chat-log').value += (username2 + ' ' + data.message + '\n');
                    picture = data.canvas;

                    var div = document.querySelector('#roommates');
                    let list = document.querySelector('#list_roommates');
                    if (username2 == username){
                    }
                    else{
                        if (document.getElementById("li_"+username2)){

                        }
                        else {
                            if (status == "Creator"){
                                let select = document.createElement('select');
                                select.id = username2;
                                select.setAttribute("onchange", "ChangeStatus(this)");
                                select.style.marginLeft = '6px';

                                let option_editor = document.createElement('option');
                                let option_witness = document.createElement('option');
                                option_editor.value = 'Editor';
                                option_editor.innerHTML = 'Editor';
                                option_witness.value = 'Witness';
                                option_witness.innerHTML = 'Witness';
                                select.appendChild(option_editor);
                                select.appendChild(option_witness);

                                let newDiv = document.createElement('li');
                                newDiv.id = 'li_' + username2;
                                let newDivText = document.createElement('span');
                                newDivText.textContent = username2;
                                let deleteButton = document.createElement('button');
                                deleteButton.textContent = 'X';
                                deleteButton.style.BackgroundColor = 'white';
                                deleteButton.style.color = 'red';
                                deleteButton.style.marginLeft='6px';
                                deleteButton.id = 'delete_'+username2;
                                newDiv.appendChild(newDivText);
                                newDiv.appendChild(select);
                                newDiv.appendChild(deleteButton);

                                list.appendChild(newDiv);
                            }
                            else {
                                let newDiv = document.createElement('li');
                                let DivStatus =  document.createElement('span');
                                DivStatus.id = ''+username2 +'_status';
                                newDiv.id = 'li_' + username2;
                                let newDivText = document.createElement('span');
                                newDivText.textContent = username2 +': ';
                                DivStatus.textContent = 'Editor';
                                newDiv.appendChild(newDivText);
                                newDiv.appendChild(DivStatus);

                                list.appendChild(newDiv);
                            }
                        }
                    }


            }
            if (type == "edit_canvas"){
                drawData.push(data.data);
            }

            if (type == "close"){
                document.querySelector('#chat-log').value += ( data.message + '\n');
            }
            if (type == "exit"){
                document.querySelector('#chat-log').value += ( data.message + '\n');
                if (data.username == username){window.location.pathname = '/';}
            }
            if (type == "creator_close"){
                alert('Creator left, the room does no longer exists ;(');
                window.location.pathname = '/';
            }
            if (type == "change_status"){
                if (status != 'Creator'){
                    id = data.username + '_status';
                    console.log(id);
                    if (data.username == username){
                        document.querySelector('#my_status').textContent = data.status;
                    }
                    else{
                        console.log(document.getElementById(id));
                        document.getElementById(id).textContent = data.status;
                    }
                }
            }
        };


        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {
                document.querySelector('#chat-message-submit').click();
            }
        };


        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                type: "chat",
                message: message,
                username:username,
            }));
            messageInputDom.value = '';
        };



    </script>
</body>
</html>